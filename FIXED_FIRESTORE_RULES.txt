rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper function to check if user has access to workspace
    function hasWorkspaceAccess(workspaceId) {
      let workspace = get(/databases/$(database)/documents/workspaces/$(workspaceId)).data;
      return workspace.ownerId == request.auth.uid || 
             workspace.members[request.auth.uid] != null;
    }
    
    // Helper function to check if user can edit workspace
    function canEditWorkspace(workspaceId) {
      let workspace = get(/databases/$(database)/documents/workspaces/$(workspaceId)).data;
      return workspace.ownerId == request.auth.uid || 
             workspace.members[request.auth.uid] == 'editor';
    }
    
    // Workspaces collection
    match /workspaces/{workspaceId} {
      // Allow read if user is owner or member
      // Also allow read for invitation acceptance (unauthenticated users viewing invitation)
      // Security: We validate invitation in app layer before showing workspace details
      allow read: if request.auth != null && 
                     (resource == null || 
                      resource.data.ownerId == request.auth.uid || 
                      resource.data.members[request.auth.uid] != null) ||
                  // Allow reading workspace for invitation acceptance screen
                  // This allows unauthenticated users to see workspace name/description when accepting
                  // We validate the invitation exists and is valid in the app layer
                  (resource != null);
      
      // Allow create if user sets themselves as owner
      allow create: if request.auth != null && 
                       request.resource.data.ownerId == request.auth.uid;
      
      // Allow update if user is owner
      // Also allow update when user is adding themselves as a member (invitation acceptance)
      allow update: if request.auth != null && 
                       (resource.data.ownerId == request.auth.uid ||
                        // Allow user to add themselves to members map (for invitation acceptance)
                        // Works for both Editor and Viewer roles
                        // Security: We validate invitation exists and is valid in app layer
                        // Check: user is being added (exists in new data, not in old data)
                        (request.resource.data.members != null &&
                         request.resource.data.members[request.auth.uid] != null &&
                         (resource.data.members == null || 
                          resource.data.members[request.auth.uid] == null)));
      
      // Allow delete only if user is owner
      allow delete: if request.auth != null && 
                       resource.data.ownerId == request.auth.uid;
    }
    
    // Notes collection
    match /notes/{noteId} {
      // Allow read if user has access to the workspace
      // For queries (resource == null), allow query to proceed - Firestore validates each document
      // For individual reads, check workspace access
      allow read: if request.auth != null && 
                     (resource == null || 
                      (resource.data.workspaceId != null && 
                       hasWorkspaceAccess(resource.data.workspaceId)));
      
      // Allow create if user has edit access to workspace
      allow create: if request.auth != null && 
                       request.resource.data.workspaceId != null &&
                       request.resource.data.userId == request.auth.uid &&
                       canEditWorkspace(request.resource.data.workspaceId);
      
      // Allow update if user has edit access to workspace
      allow update: if request.auth != null && 
                       resource.data.workspaceId != null &&
                       canEditWorkspace(resource.data.workspaceId) &&
                       request.resource.data.workspaceId == resource.data.workspaceId;
      
      // Allow delete if user has edit access to workspace
      allow delete: if request.auth != null && 
                       resource.data.workspaceId != null &&
                       canEditWorkspace(resource.data.workspaceId);
    }
    
    // Invitations collection
    match /invitations/{invitationId} {
      // Allow read for anyone (invitation tokens are meant to be shareable)
      // For queries (resource == null), allow query to proceed - Firestore validates each document
      // For individual reads, allow anyone to read (needed to view invitation by token)
      // Security: Token is the security mechanism - we validate expiry/usage in app layer
      allow read: if true;
      
      // Allow create if user is workspace owner
      // Directly check workspace ownership
      allow create: if request.auth != null && 
                       request.resource.data.createdBy == request.auth.uid &&
                       request.resource.data.workspaceId != null &&
                       get(/databases/$(database)/documents/workspaces/$(request.resource.data.workspaceId)).data.ownerId == request.auth.uid;
      
      // Allow update to mark as used (when accepting invitation)
      allow update: if request.auth != null && 
                       (resource.data.createdBy == request.auth.uid ||
                        get(/databases/$(database)/documents/workspaces/$(resource.data.workspaceId)).data.ownerId == request.auth.uid ||
                        (request.resource.data.isUsed == true && 
                         request.resource.data.usedBy == request.auth.uid));
      
      // Allow delete if user is workspace owner
      allow delete: if request.auth != null && 
                       get(/databases/$(database)/documents/workspaces/$(resource.data.workspaceId)).data.ownerId == request.auth.uid;
    }
  }
}
