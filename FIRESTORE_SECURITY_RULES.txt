rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper function to check if user has access to workspace
    function hasWorkspaceAccess(workspaceId) {
      let workspace = get(/databases/$(database)/documents/workspaces/$(workspaceId)).data;
      return workspace.ownerId == request.auth.uid || 
             workspace.members[request.auth.uid] != null;
    }
    
    // Helper function to check if user can edit workspace
    function canEditWorkspace(workspaceId) {
      let workspace = get(/databases/$(database)/documents/workspaces/$(workspaceId)).data;
      return workspace.ownerId == request.auth.uid || 
             workspace.members[request.auth.uid] == 'editor';
    }
    
    // Helper function to check if user is workspace owner
    function isWorkspaceOwner(workspaceId) {
      let workspace = get(/databases/$(database)/documents/workspaces/$(workspaceId)).data;
      return workspace.ownerId == request.auth.uid;
    }
    
    // Workspaces collection
    match /workspaces/{workspaceId} {
      // Allow read if user is owner or member, or for invitation acceptance
      allow read: if request.auth != null && 
                     (resource == null || 
                      resource.data.ownerId == request.auth.uid || 
                      resource.data.members[request.auth.uid] != null) ||
                  // Allow reading workspace for invitation acceptance screen
                  (resource != null);
      
      // Allow create if user sets themselves as owner
      allow create: if request.auth != null && 
                       request.resource.data.ownerId == request.auth.uid;
      
      // Allow update if user is owner OR adding/updating themselves as member (invitation acceptance)
      // Owners can update anything including member roles
      allow update: if request.auth != null && 
                       (// Owner can update anything (including member roles)
                        resource.data.ownerId == request.auth.uid ||
                        // User can add themselves OR update their own role (for invitation acceptance)
                        // Allows: adding new member OR updating existing member role
                        // Check: they're in the new members map and not changing owner
                        (resource.data.ownerId != request.auth.uid &&
                         request.resource.data.members != null &&
                         request.resource.data.members[request.auth.uid] != null &&
                         request.resource.data.ownerId == resource.data.ownerId));
      
      // Allow delete only if user is owner
      allow delete: if request.auth != null && 
                       resource.data.ownerId == request.auth.uid;
    }
    
    // Notes collection
    match /notes/{noteId} {
      // Allow read if user has access to the workspace
      allow read: if request.auth != null && 
                     (resource == null || 
                      (resource.data.workspaceId != null && 
                       hasWorkspaceAccess(resource.data.workspaceId)));
      
      // Allow create if user has edit access to workspace
      allow create: if request.auth != null && 
                       request.resource.data.workspaceId != null &&
                       request.resource.data.userId == request.auth.uid &&
                       canEditWorkspace(request.resource.data.workspaceId);
      
      // Allow update if user has edit access to workspace
      allow update: if request.auth != null && 
                       resource.data.workspaceId != null &&
                       canEditWorkspace(resource.data.workspaceId) &&
                       request.resource.data.workspaceId == resource.data.workspaceId;
      
      // Allow delete if user has edit access to workspace
      allow delete: if request.auth != null && 
                       resource.data.workspaceId != null &&
                       canEditWorkspace(resource.data.workspaceId);
    }
    
    // Invitations collection
    match /invitations/{invitationId} {
      // Allow read for anyone (invitation tokens are shareable)
      allow read: if true;
      
      // Allow create if user is workspace owner
      allow create: if request.auth != null && 
                       request.resource.data.createdBy == request.auth.uid &&
                       request.resource.data.workspaceId != null &&
                       get(/databases/$(database)/documents/workspaces/$(request.resource.data.workspaceId)).data.ownerId == request.auth.uid;
      
      // Allow update to mark as used (when accepting invitation) OR by owner to revoke
      allow update: if request.auth != null && 
                       (resource.data.createdBy == request.auth.uid ||
                        get(/databases/$(database)/documents/workspaces/$(resource.data.workspaceId)).data.ownerId == request.auth.uid ||
                        (request.resource.data.isUsed == true && 
                         request.resource.data.usedBy == request.auth.uid));
      
      // Allow delete if user is workspace owner
      allow delete: if request.auth != null && 
                       get(/databases/$(database)/documents/workspaces/$(resource.data.workspaceId)).data.ownerId == request.auth.uid;
    }
  }
}
